import Head from 'next/head'
import {useState, useEffect} from 'react'
import Input from './Components/Input/Input'
import MessageList from './Components/MessageList/MessageList'
import {Message} from './models'


export default function Chat() {

  const [userName, setUserName] = useState('')
  const [messageTextBoxValue, setMessageTextBoxValue] = useState<string>('')
  const [messages, setMessages] = useState<Message[]>([])
  const [isUserNameSubmitted, setIsUserNameSubmitted] = useState(false);
  
  useEffect(()=>{
    //Update Current userName on tab 'F5'
    if (sessionStorage.getItem("userName")){
      setIsUserNameSubmitted(true);
      let userName = sessionStorage.getItem("userName")
      if (typeof userName === "string"){
        setUserName(userName)
      }
    }
    //Update messages on tab 'F5'
    if (localStorage.getItem("messages")){
      updateMessageListFromStorage();
    }
    //set event to
    //listen changes on LocalStorages (for new messages)
    window.onstorage = () => {
      updateMessageListFromStorage()
    };
  }, []);
  
  function updateMessageListFromStorage() {
    let listOfMessagesFromStorage = localStorage.getItem("messages");
    if (typeof listOfMessagesFromStorage === 'string'){
      let parsedList = JSON.parse(listOfMessagesFromStorage);
      setMessages(parsedList);
    }
  }

  function inputNameHandler(value: string){
    setUserName(value);
  }

  function submitNameHandler(e: React.FormEvent<HTMLFormElement>){
    e.preventDefault();
    if (userName!==''){
      sessionStorage.setItem("userName", userName);
      setIsUserNameSubmitted(true);
    }
  }

  function inputMessageHandler(value: string){
    setMessageTextBoxValue(value)
  }

  function submitMessageHandler(e: React.FormEvent<HTMLFormElement>){
    e.preventDefault();
    let listOfMessages = messages;
    listOfMessages.push({user: userName, text: messageTextBoxValue, id:messages.length + 1})
    setMessages(listOfMessages);
    localStorage.setItem('messages', JSON.stringify(messages));
    setMessageTextBoxValue('');
  }
  
  return (
    <div>
      <Head>
        <title>Lonely chat</title>
        <meta name="description" content="Generated by create next app" />
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossOrigin="anonymous" />
        <script defer src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4" crossOrigin="anonymous"></script>
      </Head>
      <div className='container' style={{background: 'linear-gradient(29.52deg, #081021 15.41%, #215873 83.76%)'}}>
        <div className='row justify-content-center mt-3'>
          <div className="col-6 col-xs-12 h3 text-center">Lonely chat</div>  
        </div>

        {(()=>{
          if (!isUserNameSubmitted){
            return (
              <div className="row mt-3">
                <div className="col-lg-4 offset-lg-4 col-sm-6 offset-sm-3">
                  <Input
                    submitHandler={(e: React.FormEvent<HTMLFormElement>) =>
                      submitNameHandler(e)
                    }
                    inputHandler={(value: string) => inputNameHandler(value)}
                    value={userName}
                    target={"authorization"}
                  />
                </div>
              </div>
            );
          }
          return (
            <div >
              <div className='row justify-content-center mt-3'>
                <div className="col-6 col-xs-12 h4 text-center">{userName}</div>  
              </div>  
              <div
                className="d-flex flex-column-reverse"
                style={{ height: "80vh" }}
              >
              <Input
                submitHandler={(e: React.FormEvent<HTMLFormElement>) =>
                  submitMessageHandler(e)
                }
                inputHandler={(value: string) => inputMessageHandler(value)}
                value={messageTextBoxValue}
                target={"message"}
                />
              <MessageList messages={messages} userName={userName} />
              </div>
            </div>
          );
        })()}
      </div>
    </div>
  )
}
